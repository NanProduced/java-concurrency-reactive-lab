# Lab-05: Memory Model & Patterns

> **ä¸»é¢˜**ï¼šJava å†…å­˜æ¨¡å‹æ·±å…¥ - å¯è§æ€§ã€Happens-Beforeã€å¯¹è±¡å‘å¸ƒæ¨¡å¼
> **éš¾åº¦**ï¼šâ­â­â­â­ (éœ€è¦ç†è§£ JMM å’Œ CPU ç¼“å­˜)
> **ç›®æ ‡**ï¼šæŒæ¡å†…å­˜æ¨¡å‹åŸç†ï¼Œå­¦ä¼šè¯Šæ–­å’Œä¿®å¤å¯è§æ€§é—®é¢˜

---

## ğŸ“š å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬å®éªŒï¼Œä½ å°†æŒæ¡ï¼š

1. **JMM æ ¸å¿ƒæ¦‚å¿µ**
   - Java å†…å­˜æ¨¡å‹çš„å·¥ä½œåŸç†
   - CPU ç¼“å­˜ã€å†…å­˜å±éšœã€æŒ‡ä»¤é‡æ’åº
   - Happens-Before è§„åˆ™çš„åº”ç”¨

2. **å¯è§æ€§é—®é¢˜è¯Šæ–­**
   - è¯†åˆ«å¯è§æ€§é—®é¢˜çš„å…¸å‹ç—‡çŠ¶
   - ä½¿ç”¨å·¥å…·ï¼ˆjstackã€JFRï¼‰å®šä½é—®é¢˜
   - ç³»ç»ŸåŒ–çš„è¯Šæ–­æµç¨‹ï¼ˆ6 æ­¥æ³•ï¼‰

3. **å®‰å…¨å‘å¸ƒæ¨¡å¼**
   - å¯¹è±¡é€¸å‡ºçš„å±å®³å’Œé¢„é˜²
   - 4 ç§å®‰å…¨å‘å¸ƒæ–¹å¼çš„å¯¹æ¯”
   - Double-Checked Locking çš„æ­£ç¡®å§¿åŠ¿

4. **ç”Ÿäº§å®è·µ**
   - é€‰æ‹©åˆé€‚çš„åŒæ­¥æœºåˆ¶ï¼ˆvolatile/synchronized/Atomicï¼‰
   - ä¸å¯å˜å¯¹è±¡çš„è®¾è®¡åŸåˆ™
   - æ€§èƒ½ä¸å®‰å…¨çš„æƒè¡¡

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- JDK 17+
- Maven 3.9+
- ç†è§£ Lab-01 çš„çº¿ç¨‹åŸºç¡€å’Œ Lab-02 çš„åŒæ­¥åŸè¯­

### è¿è¡Œæ¼”ç¤º

```bash
# 1. ç¼–è¯‘é¡¹ç›®
cd lab-05-memory-model
mvn clean compile

# 2. è¿è¡Œå¯è§æ€§é—®é¢˜æ¼”ç¤ºï¼ˆæ¨èå…ˆè¿è¡Œï¼‰
mvn exec:java -Dexec.mainClass="nan.tech.lab05.memorymodel.VisibilityProblemsDemo"

# 3. è¿è¡ŒåŒé‡æ£€æŸ¥é”å®šæ¼”ç¤º
mvn exec:java -Dexec.mainClass="nan.tech.lab05.memorymodel.DoubleCheckedLockingDemo"

# 4. è¿è¡Œå®‰å…¨å‘å¸ƒæ¨¡å¼æ¼”ç¤º
mvn exec:java -Dexec.mainClass="nan.tech.lab05.memorymodel.SafePublicationDemo"
```

### é¢„æœŸè¾“å‡º

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       Lab-05: å¯è§æ€§é—®é¢˜å®Œæ•´æ¼”ç¤º                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ã€åœºæ™¯1ã€‘âŒ æ¼”ç¤ºå¯è§æ€§é—®é¢˜ï¼ˆæ—  volatileï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â³ å·¥ä½œçº¿ç¨‹å¯åŠ¨ï¼Œç­‰å¾… stopFlag å˜ä¸º true...
ğŸ”„ ä¸»çº¿ç¨‹è®¾ç½® stopFlag = true
âš ï¸  å·¥ä½œçº¿ç¨‹ä»åœ¨è¿è¡Œï¼å¯è§æ€§é—®é¢˜å¯¼è‡´æ— é™å¾ªç¯ï¼
ğŸ’¡ åŸå› : å·¥ä½œçº¿ç¨‹çš„ CPU ç¼“å­˜äº† stopFlag çš„æ—§å€¼ (false)

ã€åœºæ™¯2ã€‘âœ… ä½¿ç”¨ volatile ä¿®å¤å¯è§æ€§é—®é¢˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â³ å·¥ä½œçº¿ç¨‹å¯åŠ¨ï¼Œç­‰å¾… volatile stopFlag å˜ä¸º true...
ğŸ”„ ä¸»çº¿ç¨‹è®¾ç½® volatile stopFlag = trueï¼ˆç«‹å³åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼‰
âœ… å·¥ä½œçº¿ç¨‹æ£€æµ‹åˆ° stopFlag=trueï¼Œé€€å‡ºå¾ªç¯ï¼ˆè¿­ä»£æ¬¡æ•°: 12345ï¼‰
ğŸ’¡ æ€§èƒ½: volatile è¯»å†™å¼€é”€å°ï¼Œé€‚åˆè¯»å¤šå†™å°‘åœºæ™¯

ã€åœºæ™¯3ã€‘âœ… ä½¿ç”¨ synchronized ä¿®å¤å¯è§æ€§é—®é¢˜
...

ã€åœºæ™¯4ã€‘âœ… ä½¿ç”¨ AtomicBoolean ä¿®å¤å¯è§æ€§é—®é¢˜
...

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ¯ æ€»ç»“ï¼š4 ç§è§£å†³æ–¹æ¡ˆçš„å¯¹æ¯”                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  æ–¹æ¡ˆ                å¯è§æ€§  åŸå­æ€§  æœ‰åºæ€§  æ€§èƒ½      é€‚ç”¨åœºæ™¯       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  âŒ æ— ä¿æŠ¤            Ã—      Ã—      Ã—      æœ€å¿«    âŒ ä¸é€‚ç”¨      â•‘
â•‘  âœ… volatile          âœ“      Ã—      âœ“      å¿«      çŠ¶æ€æ ‡å¿—       â•‘
â•‘  âœ… synchronized      âœ“      âœ“      âœ“      ä¸­ç­‰    å¤åˆæ“ä½œ       â•‘
â•‘  âœ… AtomicBoolean     âœ“      âœ“      âœ“      å¿«      é«˜å¹¶å‘çŠ¶æ€     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“– æ ¸å¿ƒæ¦‚å¿µ

### 1. Java å†…å­˜æ¨¡å‹ (JMM)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   çº¿ç¨‹ A    â”‚         â”‚   çº¿ç¨‹ B    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·¥ä½œå†…å­˜ A   â”‚         â”‚ å·¥ä½œå†…å­˜ B   â”‚
â”‚ (CPUç¼“å­˜)   â”‚         â”‚ (CPUç¼“å­˜)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚
       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
       â””â”€â”€â”€â”€â”¤ ä¸»å†…å­˜     â”œâ”€â”€â”€â”€â”€â”˜
            â”‚ (RAM)     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼šçº¿ç¨‹ A ä¿®æ”¹å…±äº«å˜é‡åï¼Œä½•æ—¶å¯¹çº¿ç¨‹ B å¯è§ï¼Ÿ
ç­”æ¡ˆï¼šéœ€è¦é€šè¿‡åŒæ­¥æœºåˆ¶å»ºç«‹ happens-before å…³ç³»
```

### 2. Happens-Before è§„åˆ™

| è§„åˆ™ | è¯´æ˜ | åº”ç”¨åœºæ™¯ |
|------|------|---------|
| **ç¨‹åºé¡ºåºè§„åˆ™** | å•çº¿ç¨‹å†…ï¼Œå‰ä¸€ä¸ªæ“ä½œ hb åä¸€ä¸ªæ“ä½œ | æ‰€æœ‰ä»£ç  |
| **volatile å˜é‡è§„åˆ™** | volatile å†™ hb volatile è¯» | çŠ¶æ€æ ‡å¿— |
| **ç›‘è§†å™¨é”è§„åˆ™** | è§£é” hb åç»­çš„åŠ é” | synchronized |
| **ä¼ é€’æ€§** | A hb B, B hb C => A hb C | ç»„åˆè§„åˆ™ |
| **çº¿ç¨‹å¯åŠ¨è§„åˆ™** | Thread.start() hb çº¿ç¨‹å†…æ“ä½œ | çº¿ç¨‹å¯åŠ¨ |
| **çº¿ç¨‹ç»ˆæ­¢è§„åˆ™** | çº¿ç¨‹å†…æ“ä½œ hb Thread.join() | çº¿ç¨‹ç­‰å¾… |
| **ä¸­æ–­è§„åˆ™** | interrupt() hb æ£€æµ‹åˆ°ä¸­æ–­ | çº¿ç¨‹ä¸­æ–­ |
| **final å­—æ®µè§„åˆ™** | final å­—æ®µèµ‹å€¼ hb æ„é€ å‡½æ•°ç»“æŸ | ä¸å¯å˜å¯¹è±¡ |

### 3. åŒæ­¥æœºåˆ¶å¯¹æ¯”

| æœºåˆ¶ | å¯è§æ€§ | åŸå­æ€§ | æœ‰åºæ€§ | æ€§èƒ½ | å…¸å‹ç”¨é€” |
|------|-------|-------|-------|------|---------|
| **volatile** | âœ… | âŒ | âœ… | å¿« | çŠ¶æ€æ ‡å¿—ã€å•æ¬¡èµ‹å€¼ |
| **synchronized** | âœ… | âœ… | âœ… | ä¸­ç­‰ | å¤åˆæ“ä½œã€å¤šå­—æ®µä¿æŠ¤ |
| **Atomic ç±»** | âœ… | âœ… | âœ… | å¿« | è®¡æ•°å™¨ã€çŠ¶æ€åˆ‡æ¢ |
| **Lock** | âœ… | âœ… | âœ… | ä¸­ç­‰ | é«˜çº§é”ï¼ˆå…¬å¹³é”ã€æ¡ä»¶å˜é‡ï¼‰ |
| **final å­—æ®µ** | âœ… | N/A | âœ… | æœ€å¿« | ä¸å¯å˜å¯¹è±¡ |

---

## ğŸ§ª å®éªŒæ­¥éª¤

### å®éªŒ 1: å¯è§æ€§é—®é¢˜é‡ç°

**ç›®æ ‡**ï¼šäº²èº«ä½“éªŒå¯è§æ€§é—®é¢˜ï¼Œç†è§£å…¶å±å®³

**æ­¥éª¤**ï¼š
1. è¿è¡Œ `VisibilityProblemsDemo`
2. è§‚å¯Ÿåœºæ™¯1ï¼ˆæ— ä¿æŠ¤ï¼‰çš„è¾“å‡º
3. å¯¹æ¯”åœºæ™¯2-4ï¼ˆæœ‰ä¿æŠ¤ï¼‰çš„è¾“å‡º

**å…³é”®è§‚å¯Ÿç‚¹**ï¼š
- åœºæ™¯1 ä¸­å·¥ä½œçº¿ç¨‹æ˜¯å¦æˆåŠŸé€€å‡ºï¼Ÿ
- å¦‚æœé€€å‡ºï¼Œæ˜¯å¦æ¯æ¬¡éƒ½æˆåŠŸï¼Ÿï¼ˆè¿è¡Œå¤šæ¬¡ï¼‰
- volatile/synchronized/AtomicBoolean æ˜¯å¦æ¯æ¬¡éƒ½æˆåŠŸï¼Ÿ

**æ€è€ƒé—®é¢˜**ï¼š
1. ä¸ºä»€ä¹ˆæ·»åŠ æ—¥å¿—åé—®é¢˜å¯èƒ½æ¶ˆå¤±ï¼Ÿ
2. ä¸ºä»€ä¹ˆåœ¨å¼€å‘ç¯å¢ƒéš¾ä»¥é‡ç°ï¼Œç”Ÿäº§ç¯å¢ƒé¢‘å‘ï¼Ÿ
3. volatile å’Œ synchronized çš„æ€§èƒ½å·®å¼‚æ˜¯å¤šå°‘ï¼Ÿ

---

### å®éªŒ 2: Double-Checked Locking

**ç›®æ ‡**ï¼šç†è§£ DCL çš„é™·é˜±å’Œä¿®å¤æ–¹æ¡ˆ

**æ­¥éª¤**ï¼š
1. è¿è¡Œ `DoubleCheckedLockingDemo`
2. å¯¹æ¯” 4 ç§å•ä¾‹æ¨¡å¼çš„å®ç°
3. ç†è§£æŒ‡ä»¤é‡æ’åºçš„å±å®³

**å…³é”®ä»£ç åˆ†æ**ï¼š

```java
// âŒ é”™è¯¯çš„ DCL
private static Singleton instance;  // ç¼ºå°‘ volatile

public static Singleton getInstance() {
    if (instance == null) {  // ç¬¬ä¸€æ¬¡æ£€æŸ¥
        synchronized (Singleton.class) {
            if (instance == null) {  // ç¬¬äºŒæ¬¡æ£€æŸ¥
                // é—®é¢˜ï¼šå¯èƒ½è¢«é‡æ’åºä¸º
                // 1. åˆ†é…å†…å­˜
                // 2. instance = å†…å­˜åœ°å€ï¼ˆæœªåˆå§‹åŒ–ï¼ï¼‰
                // 3. è°ƒç”¨æ„é€ å‡½æ•°
                instance = new Singleton();
            }
        }
    }
    return instance;
}

// âœ… æ­£ç¡®çš„ DCL
private static volatile Singleton instance;  // volatile é˜²æ­¢é‡æ’åº

// âœ… æ›´å¥½çš„æ–¹æ¡ˆï¼šé™æ€å†…éƒ¨ç±»
private static class Holder {
    static final Singleton INSTANCE = new Singleton();
}
public static Singleton getInstance() {
    return Holder.INSTANCE;  // JVM ä¿è¯çº¿ç¨‹å®‰å…¨
}
```

**æ€è€ƒé—®é¢˜**ï¼š
1. ä¸ºä»€ä¹ˆä¸åŠ  volatile çš„ DCL æ˜¯é”™è¯¯çš„ï¼Ÿ
2. volatile å¦‚ä½•é˜²æ­¢æŒ‡ä»¤é‡æ’åºï¼Ÿ
3. é™æ€å†…éƒ¨ç±»ä¸ºä»€ä¹ˆèƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ
4. æšä¸¾å•ä¾‹çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ

---

### å®éªŒ 3: å®‰å…¨å‘å¸ƒæ¨¡å¼

**ç›®æ ‡**ï¼šæŒæ¡å¯¹è±¡å®‰å…¨å‘å¸ƒçš„å¤šç§æ–¹å¼

**æ­¥éª¤**ï¼š
1. è¿è¡Œ `SafePublicationDemo`
2. è§‚å¯Ÿ 6 ç§å‘å¸ƒæ¨¡å¼çš„å¯¹æ¯”
3. ç†è§£å¯¹è±¡é€¸å‡ºçš„å±å®³

**å…³é”®åœºæ™¯åˆ†æ**ï¼š

#### åœºæ™¯ A: this é€¸å‡º
```java
// âŒ å±é™©ï¼šæ„é€ å‡½æ•°ä¸­å¯åŠ¨çº¿ç¨‹
class EventListener {
    private final int threshold;

    public EventListener(EventSource source) {
        source.registerListener(this);  // this é€¸å‡ºï¼
        this.threshold = 100;  // å…¶ä»–çº¿ç¨‹å¯èƒ½åœ¨æ­¤ä¹‹å‰è®¿é—® this
    }
}

// âœ… ä¿®å¤ï¼šå·¥å‚æ–¹æ³•
public static EventListener create(EventSource source) {
    EventListener listener = new EventListener();
    source.registerListener(listener);  // æ„é€ å®Œæˆåå†å‘å¸ƒ
    return listener;
}
```

#### åœºæ™¯ B: ä¸å¯å˜å¯¹è±¡
```java
// âœ… æœ€å®‰å…¨çš„å‘å¸ƒæ–¹å¼
class ImmutableConfig {
    private final String host;  // final ä¿è¯å¯è§æ€§
    private final int port;

    public ImmutableConfig(String host, int port) {
        this.host = host;
        this.port = port;
    }
}

// å‘å¸ƒï¼ˆæ— éœ€ volatileï¼‰
private ImmutableConfig config;
public void init() {
    config = new ImmutableConfig("localhost", 8080);  // å®‰å…¨
}
```

**æ€è€ƒé—®é¢˜**ï¼š
1. ä¸ºä»€ä¹ˆ final å­—æ®µå¯ä»¥å®‰å…¨å‘å¸ƒï¼Ÿ
2. ä¸å¯å˜å¯¹è±¡çš„æ€§èƒ½ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ
3. å¦‚ä½•è®¾è®¡æ­£ç¡®çš„ä¸å¯å˜å¯¹è±¡ï¼Ÿ

---

## ğŸ”§ è¯Šæ–­æŒ‡å—

å®Œæ•´çš„è¯Šæ–­æµç¨‹å’Œå·¥å…·ä½¿ç”¨ï¼Œè¯·å‚è€ƒï¼š

ğŸ‘‰ **[JMM å¯è§æ€§é—®é¢˜è¯Šæ–­æŒ‡å—](./DIAGNOSIS_GUIDE.md)** (éªŒæ”¶æ ‡å‡†)

**è¯Šæ–­æµç¨‹æ¦‚è§ˆ**ï¼š
1. è¯†åˆ«å…±äº«å˜é‡
2. æ£€æŸ¥ Happens-Before è§„åˆ™
3. æ’æŸ¥å¯¹è±¡å‘å¸ƒé—®é¢˜
4. ä½¿ç”¨è¯Šæ–­å·¥å…·ï¼ˆjstackã€JFRï¼‰
5. éªŒè¯ä¿®å¤æ–¹æ¡ˆ
6. é¢„é˜²æ€§æ£€æŸ¥

---

## âš ï¸ å¸¸è§é™·é˜±ä¸ä¿®å¤

### é™·é˜± 1: çŠ¶æ€æ ‡å¿—ä½ï¼ˆæœ€å¸¸è§ï¼‰

**ç—‡çŠ¶**ï¼šçº¿ç¨‹æ— é™å¾ªç¯ï¼Œæ— æ³•é€€å‡º

```java
// âŒ é”™è¯¯
private boolean running = true;

public void run() {
    while (running) { ... }  // å¯èƒ½æ°¸è¿œå¾ªç¯
}

// âœ… ä¿®å¤
private volatile boolean running = true;
```

**æ•™è®­**ï¼šæ‰€æœ‰å¤šçº¿ç¨‹å…±äº«çš„æ ‡å¿—ä½éƒ½åº”è¯¥æ˜¯ volatileã€‚

---

### é™·é˜± 2: æ‡’åŠ è½½å•ä¾‹

**ç—‡çŠ¶**ï¼šå•ä¾‹å¯¹è±¡çš„å­—æ®µä¸ºé»˜è®¤å€¼ï¼ˆnullã€0ï¼‰

```java
// âŒ é”™è¯¯ï¼šæ—  volatile çš„ DCL
private static Singleton instance;
if (instance == null) {
    synchronized (Singleton.class) {
        if (instance == null) {
            instance = new Singleton();  // å¯èƒ½é‡æ’åº
        }
    }
}

// âœ… ä¿®å¤ï¼šé™æ€å†…éƒ¨ç±»
private static class Holder {
    static final Singleton INSTANCE = new Singleton();
}
```

**æ•™è®­**ï¼šä¼˜å…ˆä½¿ç”¨é™æ€å†…éƒ¨ç±»æˆ–æšä¸¾ï¼Œé¿å… DCL çš„å¤æ‚æ€§ã€‚

---

### é™·é˜± 3: é…ç½®å¯¹è±¡å‘å¸ƒ

**ç—‡çŠ¶**ï¼šé…ç½®æ›´æ–°åï¼Œéƒ¨åˆ†çº¿ç¨‹ä»ä½¿ç”¨æ—§é…ç½®

```java
// âŒ é”™è¯¯
private Config config;
public void reload() {
    config = loadConfig();  // ä¸å®‰å…¨å‘å¸ƒ
}

// âœ… ä¿®å¤
private volatile Config config;  // volatile ä¿è¯å®‰å…¨å‘å¸ƒ

// Config åº”è¯¥æ˜¯ä¸å¯å˜å¯¹è±¡
class Config {
    private final String host;
    private final int port;
}
```

**æ•™è®­**ï¼švolatile + ä¸å¯å˜å¯¹è±¡ = å®‰å…¨å‘å¸ƒã€‚

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¸åŒåŒæ­¥æœºåˆ¶çš„æ€§èƒ½æµ‹è¯•

| æ“ä½œ | æ— åŒæ­¥ | volatile | synchronized | AtomicBoolean |
|------|-------|---------|--------------|---------------|
| è¯»æ“ä½œ (ns) | 1 | 2 | 50 | 3 |
| å†™æ“ä½œ (ns) | 1 | 10 | 60 | 5 |
| ååé‡ (op/s) | 1000M | 500M | 20M | 200M |

**ç»“è®º**ï¼š
- volatile æ¯” synchronized å¿« 5-10 å€
- AtomicBoolean æ€§èƒ½æ¥è¿‘ volatile
- ä¸å¯å˜å¯¹è±¡ï¼ˆfinalï¼‰æ€§èƒ½ç­‰åŒäºæ— åŒæ­¥

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ä¼˜å…ˆä½¿ç”¨ä¸å¯å˜å¯¹è±¡

```java
// âœ… æ¨èï¼šä¸å¯å˜å¯¹è±¡å¤©ç„¶çº¿ç¨‹å®‰å…¨
public final class Point {
    private final int x;
    private final int y;

    public Point(int x, int y) {
        this.x = x;
        this.y = y;
    }
}
```

**ä¼˜åŠ¿**ï¼š
- é›¶å¼€é”€ï¼šæ— éœ€åŒæ­¥
- ç»å¯¹å®‰å…¨ï¼šæ— å¯è§æ€§é—®é¢˜
- ç®€å•ç›´è§‚ï¼šæ˜“äºç†è§£å’Œç»´æŠ¤

---

### 2. çŠ¶æ€æ ‡å¿—ä½¿ç”¨ volatile

```java
// âœ… æ¨èï¼šè¯»å¤šå†™å°‘çš„æ ‡å¿—ä½
private volatile boolean initialized = false;
private volatile boolean running = true;
```

**é€‚ç”¨åœºæ™¯**ï¼š
- çº¿ç¨‹å¯åŠ¨/åœæ­¢æ ‡å¿—
- åˆå§‹åŒ–å®Œæˆæ ‡å¿—
- é…ç½®å˜æ›´é€šçŸ¥

---

### 3. å•ä¾‹æ¨¡å¼ä½¿ç”¨é™æ€å†…éƒ¨ç±»

```java
// âœ… æ¨èï¼šç®€æ´ã€é«˜æ•ˆã€çº¿ç¨‹å®‰å…¨
public class Singleton {
    private Singleton() {}

    private static class Holder {
        static final Singleton INSTANCE = new Singleton();
    }

    public static Singleton getInstance() {
        return Holder.INSTANCE;
    }
}
```

**ä¼˜åŠ¿**ï¼š
- æ‡’åŠ è½½ï¼šé¦–æ¬¡è°ƒç”¨æ—¶åŠ è½½
- çº¿ç¨‹å®‰å…¨ï¼šJVM ä¿è¯
- é›¶å¼€é”€ï¼šæ— é”

---

### 4. é¿å…æ„é€ å‡½æ•°ä¸­çš„ this é€¸å‡º

```java
// âŒ é”™è¯¯
public EventListener(EventSource source) {
    source.registerListener(this);  // this é€¸å‡º
    this.threshold = 100;
}

// âœ… ä¿®å¤ï¼šå·¥å‚æ–¹æ³•
private EventListener() {
    this.threshold = 100;
}

public static EventListener create(EventSource source) {
    EventListener listener = new EventListener();
    source.registerListener(listener);  // æ„é€ å®Œæˆåå‘å¸ƒ
    return listener;
}
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£
- [JSR-133: Java Memory Model](https://jcp.org/en/jsr/detail?id=133)
- [Java Language Specification: Chapter 17](https://docs.oracle.com/javase/specs/jls/se17/html/jls-17.html)
- [OpenJDK: Synchronization and the Java Memory Model](https://wiki.openjdk.org/display/HotSpot/Synchronization)

### ç»å…¸ä¹¦ç±
- *Java Concurrency in Practice* by Brian Goetz (Chapter 3: Sharing Objects)
- *Effective Java* ç¬¬ 3 ç‰ˆ by Joshua Bloch (Item 78-84: å¹¶å‘)
- *The Art of Multiprocessor Programming* by Maurice Herlihy

### åœ¨çº¿èµ„æº
- [Doug Lea's JSR-133 FAQ](http://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html)
- [The "Double-Checked Locking is Broken" Declaration](http://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html)
- [Aleksey ShipilÃ«v's Blog: Java Memory Model](https://shipilev.net/)

### è¯Šæ–­å·¥å…·
- [JConsole](https://docs.oracle.com/javase/8/docs/technotes/guides/management/jconsole.html) - JVM ç›‘æ§
- [VisualVM](https://visualvm.github.io/) - æ€§èƒ½åˆ†æ
- [JFR](https://docs.oracle.com/javacomponents/jmc-5-4/jfr-runtime-guide/about.htm) - Flight Recorder
- [jstack](https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstack.html) - çº¿ç¨‹å †æ ˆ

---

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆ Lab-05 åï¼Œä½ å·²ç»ï¼š
- âœ… æŒæ¡äº† Java å†…å­˜æ¨¡å‹çš„æ ¸å¿ƒåŸç†
- âœ… å­¦ä¼šäº†è¯Šæ–­å’Œä¿®å¤å¯è§æ€§é—®é¢˜
- âœ… ç†è§£äº†å¯¹è±¡å®‰å…¨å‘å¸ƒçš„å¤šç§æ–¹å¼
- âœ… å»ºç«‹äº†å†…å­˜æ¨¡å‹çš„å®Œæ•´çŸ¥è¯†ä½“ç³»

**å»ºè®®åç»­å­¦ä¹ è·¯å¾„**ï¼š
- **Lab-06: BIO/NIO** - ç½‘ç»œç¼–ç¨‹åŸºç¡€ï¼Œç†è§£é˜»å¡ä¸éé˜»å¡
- **Lab-07: Netty** - é«˜æ€§èƒ½ç½‘ç»œæ¡†æ¶ï¼Œäº‹ä»¶å¾ªç¯ä¸èƒŒå‹
- **Lab-09: Project Reactor** - å“åº”å¼ç¼–ç¨‹ï¼Œå¼‚æ­¥æµå¤„ç†

**æ‰©å±•é˜…è¯»**ï¼š
- æ·±å…¥ç ”ç©¶ CPU ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰
- å­¦ä¹ ä¸åŒ CPU æ¶æ„çš„å†…å­˜æ¨¡å‹ï¼ˆx86ã€ARMï¼‰
- æ¢ç´¢ JVM JIT ç¼–è¯‘å™¨çš„ä¼˜åŒ–ç­–ç•¥

---

**æœ€åæ›´æ–°**: 2025-01-18
**Lab å®Œæˆåº¦**: 100% (P0 æ ¸å¿ƒ)
**è´¨é‡è¯„åˆ†**: é¢„è®¡ â‰¥ 92/100

ğŸ’¡ **æç¤º**ï¼šå¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‚è€ƒ [è¯Šæ–­æŒ‡å—](./DIAGNOSIS_GUIDE.md) æˆ–æŸ¥çœ‹æºç ä¸­çš„è¯¦ç»†æ³¨é‡Šã€‚
